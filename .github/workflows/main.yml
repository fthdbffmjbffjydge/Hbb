name: Check CPU Cores on Team1 and Team2 Runners
on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

jobs:
  check-team1-cores:
    runs-on: team1  # Runs on any runner with label "team1"
    
    steps:
    - name: Check CPU Cores and System Info
      run: |
        echo "=== System Information on Team1 Runner ==="
        echo "Hostname: $(hostname)"
        echo "OS: $(uname -a)"
        echo "CPU Architecture: $(uname -m)"
        echo "--- CPU Core Information ---"
        echo "Total CPU Cores: $(nproc)"
        echo "CPU Model: $(grep -m 1 "model name" /proc/cpuinfo | cut -d: -f2 | xargs)"
        echo "CPU MHz: $(grep -m 1 "cpu MHz" /proc/cpuinfo | cut -d: -f2 | xargs)"
        echo "All CPU MHz: $(grep "cpu MHz" /proc/cpuinfo | cut -d: -f2 | tr '\n' ' ')"
        echo "Min MHz: $(grep "cpu MHz" /proc/cpuinfo | cut -d: -f2 | sort -n | head -1)"
        echo "Max MHz: $(grep "cpu MHz" /proc/cpuinfo | cut -d: -f2 | sort -n | tail -1)"
        echo "--- Memory Information ---"
        echo "Total Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Available Memory: $(free -h | grep Mem | awk '{print $7}')"
        echo "--- Disk Information ---"
        echo "Disk Usage:"
        df -h | grep -E '^/dev/'
        echo "--- Runner Labels ---"
        echo "This runner has labels: ${{ toJson(env.RUNNER_LABELS) }}"

    - name: Save Core Count to Artifact
      run: |
        CORE_COUNT=$(nproc)
        CPU_MHZ=$(grep -m 1 "cpu MHz" /proc/cpuinfo | cut -d: -f2 | xargs)
        echo "CORE_COUNT=$CORE_COUNT" >> $GITHUB_ENV
        echo "CPU_MHZ=$CPU_MHZ" >> $GITHUB_ENV
        echo "Team1 runner has $CORE_COUNT CPU cores at $CPU_MHZ MHz"
        
    - name: Upload Team1 Core Info
      uses: actions/upload-artifact@v4
      with:
        name: team1-system-info
        path: |
          /proc/cpuinfo
          /proc/meminfo
        retention-days: 1

  check-team2-cores:
    runs-on: team2  # Runs on any runner with label "team2"
    
    steps:
    - name: Check CPU Cores and System Info
      run: |
        echo "=== System Information on Team2 Runner ==="
        echo "Hostname: $(hostname)"
        echo "OS: $(uname -a)"
        echo "CPU Architecture: $(uname -m)"
        echo "--- CPU Core Information ---"
        echo "Total CPU Cores: $(nproc)"
        echo "CPU Model: $(grep -m 1 "model name" /proc/cpuinfo | cut -d: -f2 | xargs)"
        echo "CPU MHz: $(grep -m 1 "cpu MHz" /proc/cpuinfo | cut -d: -f2 | xargs)"
        echo "All CPU MHz: $(grep "cpu MHz" /proc/cpuinfo | cut -d: -f2 | tr '\n' ' ')"
        echo "Min MHz: $(grep "cpu MHz" /proc/cpuinfo | cut -d: -f2 | sort -n | head -1)"
        echo "Max MHz: $(grep "cpu MHz" /proc/cpuinfo | cut -d: -f2 | sort -n | tail -1)"
        echo "--- Memory Information ---"
        echo "Total Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Available Memory: $(free -h | grep Mem | awk '{print $7}')"
        echo "--- Disk Information ---"
        echo "Disk Usage:"
        df -h | grep -E '^/dev/'
        echo "--- Runner Labels ---"
        echo "This runner has labels: ${{ toJson(env.RUNNER_LABELS) }}"

    - name: Save Core Count to Artifact
      run: |
        CORE_COUNT=$(nproc)
        CPU_MHZ=$(grep -m 1 "cpu MHz" /proc/cpuinfo | cut -d: -f2 | xargs)
        echo "CORE_COUNT=$CORE_COUNT" >> $GITHUB_ENV
        echo "CPU_MHZ=$CPU_MHZ" >> $GITHUB_ENV
        echo "Team2 runner has $CORE_COUNT CPU cores at $CPU_MHZ MHz"
        
    - name: Upload Team2 Core Info
      uses: actions/upload-artifact@v4
      with:
        name: team2-system-info
        path: |
          /proc/cpuinfo
          /proc/meminfo
        retention-days: 1

  compare-teams:
    runs-on: ubuntu-latest
    needs: [check-team1-cores, check-team2-cores]
    
    steps:
    - name: Download Team1 Artifact
      uses: actions/download-artifact@v4
      with:
        name: team1-system-info
        
    - name: Download Team2 Artifact
      uses: actions/download-artifact@v4
      with:
        name: team2-system-info
        
    - name: Compare Team Runners
      run: |
        echo "=== COMPARISON: Team1 vs Team2 Runners ==="
        echo "Team1: ${{ needs.check-team1-cores.outputs.CORE_COUNT }} cores @ ${{ needs.check-team1-cores.outputs.CPU_MHZ }} MHz"
        echo "Team2: ${{ needs.check-team2-cores.outputs.CORE_COUNT }} cores @ ${{ needs.check-team2-cores.outputs.CPU_MHZ }} MHz"
        
        # Note: For actual comparison, we'd need to parse the artifacts
        echo "Check the uploaded artifacts for detailed CPU information"
